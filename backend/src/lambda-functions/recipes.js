"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_s3_1 = require("@aws-sdk/client-s3");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const s3Client = new client_s3_1.S3Client({});
const handler = async (event) => {
    const headers = {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS',
    };
    try {
        const { httpMethod, path, pathParameters, queryStringParameters } = event;
        const body = event.body ? JSON.parse(event.body) : {};
        if (httpMethod === 'OPTIONS') {
            return {
                statusCode: 200,
                headers,
                body: '',
            };
        }
        if (path === '/recipes' && httpMethod === 'GET') {
            return await getRecipes(queryStringParameters);
        }
        if (path === '/recipes' && httpMethod === 'POST') {
            return await createRecipe(body, event.headers.Authorization);
        }
        if (pathParameters?.id && httpMethod === 'GET') {
            return await getRecipe(pathParameters.id);
        }
        if (pathParameters?.id && httpMethod === 'PUT') {
            return await updateRecipe(pathParameters.id, body, event.headers.Authorization);
        }
        if (pathParameters?.id && httpMethod === 'DELETE') {
            return await deleteRecipe(pathParameters.id, event.headers.Authorization);
        }
        return {
            statusCode: 404,
            headers,
            body: JSON.stringify({ error: 'Not found' }),
        };
    }
    catch (error) {
        console.error('Recipes error:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function getRecipes(queryParams) {
    const headers = {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
    };
    try {
        const { ingredient, userId, limit = '20', lastKey } = queryParams || {};
        let recipes = [];
        if (ingredient) {
            // Search by ingredient using GSI
            const result = await docClient.send(new lib_dynamodb_1.QueryCommand({
                TableName: process.env.RECIPES_TABLE,
                IndexName: 'ingredients-index',
                KeyConditionExpression: 'ingredient = :ingredient',
                ExpressionAttributeValues: {
                    ':ingredient': ingredient.toLowerCase(),
                },
                Limit: parseInt(limit),
            }));
            recipes = result.Items || [];
        }
        else if (userId) {
            // Get user's recipes
            const result = await docClient.send(new lib_dynamodb_1.QueryCommand({
                TableName: process.env.RECIPES_TABLE,
                IndexName: 'user-recipes-index',
                KeyConditionExpression: 'userId = :userId',
                ExpressionAttributeValues: {
                    ':userId': userId,
                },
                ScanIndexForward: false, // Most recent first
                Limit: parseInt(limit),
            }));
            recipes = result.Items || [];
        }
        else {
            // Get all recipes
            const result = await docClient.send(new lib_dynamodb_1.ScanCommand({
                TableName: process.env.RECIPES_TABLE,
                Limit: parseInt(limit),
            }));
            recipes = result.Items || [];
        }
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ recipes }),
        };
    }
    catch (error) {
        console.error('Get recipes error:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to get recipes' }),
        };
    }
}
async function createRecipe(recipeData, authorization) {
    const headers = {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
    };
    try {
        if (!authorization) {
            return {
                statusCode: 401,
                headers,
                body: JSON.stringify({ error: 'Authorization required' }),
            };
        }
        const userId = extractUserIdFromToken(authorization);
        const recipeId = generateId();
        const now = new Date().toISOString();
        const recipe = {
            recipeId,
            userId,
            title: recipeData.title,
            description: recipeData.description,
            ingredients: recipeData.ingredients || [],
            instructions: recipeData.instructions || [],
            cookingTime: recipeData.cookingTime || 30,
            difficultyLevel: recipeData.difficultyLevel || 'medium',
            servings: recipeData.servings || 4,
            dietaryTags: recipeData.dietaryTags || [],
            createdAt: now,
            updatedAt: now,
        };
        // Save recipe
        await docClient.send(new lib_dynamodb_1.PutCommand({
            TableName: process.env.RECIPES_TABLE,
            Item: recipe,
        }));
        // Save ingredient mappings for search
        for (const ingredient of recipe.ingredients) {
            await docClient.send(new lib_dynamodb_1.PutCommand({
                TableName: process.env.RECIPES_TABLE,
                Item: {
                    recipeId: recipe.recipeId,
                    ingredient: ingredient.name.toLowerCase(),
                    createdAt: now,
                },
            }));
        }
        return {
            statusCode: 201,
            headers,
            body: JSON.stringify({ recipe }),
        };
    }
    catch (error) {
        console.error('Create recipe error:', error);
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ error: 'Failed to create recipe' }),
        };
    }
}
async function getRecipe(recipeId) {
    const headers = {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
    };
    try {
        const result = await docClient.send(new lib_dynamodb_1.GetCommand({
            TableName: process.env.RECIPES_TABLE,
            Key: { recipeId }, // Use recipeId as primary key only
        }));
        if (!result.Item) {
            return {
                statusCode: 404,
                headers,
                body: JSON.stringify({ error: 'Recipe not found' }),
            };
        }
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ recipe: result.Item }),
        };
    }
    catch (error) {
        console.error('Get recipe error:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to get recipe' }),
        };
    }
}
async function updateRecipe(recipeId, recipeData, authorization) {
    const headers = {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
    };
    try {
        if (!authorization) {
            return {
                statusCode: 401,
                headers,
                body: JSON.stringify({ error: 'Authorization required' }),
            };
        }
        const userId = extractUserIdFromToken(authorization);
        // Get existing recipe
        const existingRecipe = await docClient.send(new lib_dynamodb_1.GetCommand({
            TableName: process.env.RECIPES_TABLE,
            Key: { recipeId },
        }));
        if (!existingRecipe.Item) {
            return {
                statusCode: 404,
                headers,
                body: JSON.stringify({ error: 'Recipe not found' }),
            };
        }
        if (existingRecipe.Item.userId !== userId) {
            return {
                statusCode: 403,
                headers,
                body: JSON.stringify({ error: 'Not authorized to update this recipe' }),
            };
        }
        // Update recipe
        const updatedRecipe = {
            ...existingRecipe.Item,
            ...recipeData,
            updatedAt: new Date().toISOString(),
        };
        await docClient.send(new lib_dynamodb_1.PutCommand({
            TableName: process.env.RECIPES_TABLE,
            Item: updatedRecipe,
        }));
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ recipe: updatedRecipe }),
        };
    }
    catch (error) {
        console.error('Update recipe error:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to update recipe' }),
        };
    }
}
async function deleteRecipe(recipeId, authorization) {
    const headers = {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
    };
    try {
        if (!authorization) {
            return {
                statusCode: 401,
                headers,
                body: JSON.stringify({ error: 'Authorization required' }),
            };
        }
        const userId = extractUserIdFromToken(authorization);
        // Get existing recipe to check ownership
        const existingRecipe = await docClient.send(new lib_dynamodb_1.GetCommand({
            TableName: process.env.RECIPES_TABLE,
            Key: { recipeId },
        }));
        if (!existingRecipe.Item) {
            return {
                statusCode: 404,
                headers,
                body: JSON.stringify({ error: 'Recipe not found' }),
            };
        }
        if (existingRecipe.Item.userId !== userId) {
            return {
                statusCode: 403,
                headers,
                body: JSON.stringify({ error: 'Not authorized to delete this recipe' }),
            };
        }
        // Delete recipe
        await docClient.send(new lib_dynamodb_1.DeleteCommand({
            TableName: process.env.RECIPES_TABLE,
            Key: { recipeId },
        }));
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({ message: 'Recipe deleted successfully' }),
        };
    }
    catch (error) {
        console.error('Delete recipe error:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Failed to delete recipe' }),
        };
    }
}
function generateId() {
    return Math.random().toString(36).substr(2, 9);
}
function extractUserIdFromToken(authorization) {
    const token = authorization.replace('Bearer ', '');
    return token;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVjaXBlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlY2lwZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUFpSTtBQUNqSSxrREFBcUY7QUFFckYsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUM1RCxNQUFNLFFBQVEsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7QUF3QjNCLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxLQUEyQixFQUFrQyxFQUFFO0lBQzNGLE1BQU0sT0FBTyxHQUFHO1FBQ2QsY0FBYyxFQUFFLGtCQUFrQjtRQUNsQyw2QkFBNkIsRUFBRSxHQUFHO1FBQ2xDLDhCQUE4QixFQUFFLDRCQUE0QjtRQUM1RCw4QkFBOEIsRUFBRSw2QkFBNkI7S0FDOUQsQ0FBQztJQUVGLElBQUksQ0FBQztRQUNILE1BQU0sRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxxQkFBcUIsRUFBRSxHQUFHLEtBQUssQ0FBQztRQUMxRSxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBRXRELElBQUksVUFBVSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQzdCLE9BQU87Z0JBQ0wsVUFBVSxFQUFFLEdBQUc7Z0JBQ2YsT0FBTztnQkFDUCxJQUFJLEVBQUUsRUFBRTthQUNULENBQUM7UUFDSixDQUFDO1FBRUQsSUFBSSxJQUFJLEtBQUssVUFBVSxJQUFJLFVBQVUsS0FBSyxLQUFLLEVBQUUsQ0FBQztZQUNoRCxPQUFPLE1BQU0sVUFBVSxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFD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Q1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsc0NBQXNDLEVBQUUsQ0FBQzthQUN4RSxDQUFDO1FBQ0osQ0FBQztRQUVELGdCQUFnQjtRQUNoQixNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSw0QkFBYSxDQUFDO1lBQ3JDLFNBQVMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWE7WUFDcEMsR0FBRyxFQUFFLEVBQUUsUUFBUSxFQUFFO1NBQ2xCLENBQUMsQ0FBQyxDQUFDO1FBRUosT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsT0FBTztZQUNQLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsT0FBTyxFQUFFLDZCQUE2QixFQUFFLENBQUM7U0FDakUsQ0FBQztJQUNKLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUM3QyxPQUFPO1lBQ0wsVUFBVSxFQUFFLEdBQUc7WUFDZixPQUFPO1lBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUseUJBQXlCLEVBQUUsQ0FBQztTQUMzRCxDQUFDO0lBQ0osQ0FBQztBQUNILENBQUM7QUFFRCxTQUFTLFVBQVU7SUFDakIsT0FBTyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDakQsQ0FBQztBQUVELFNBQVMsc0JBQXNCLENBQUMsYUFBcUI7SUFDbkQsTUFBTSxLQUFLLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDbkQsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgUHV0Q29tbWFuZCwgR2V0Q29tbWFuZCwgUXVlcnlDb21tYW5kLCBTY2FuQ29tbWFuZCwgRGVsZXRlQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBTM0NsaWVudCwgUHV0T2JqZWN0Q29tbWFuZCwgRGVsZXRlT2JqZWN0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5cbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vQ2xpZW50KTtcbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHt9KTtcblxuaW50ZXJmYWNlIFJlY2lwZSB7XG4gIHJlY2lwZUlkOiBzdHJpbmc7XG4gIHVzZXJJZDogc3RyaW5nO1xuICB0aXRsZTogc3RyaW5nO1xuICBkZXNjcmlwdGlvbjogc3RyaW5nO1xuICBpbmdyZWRpZW50czoge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBxdWFudGl0eTogc3RyaW5nO1xuICAgIHVuaXQ6IHN0cmluZztcbiAgfVtdO1xuICBpbnN0cnVjdGlvbnM6IHN0cmluZ1tdO1xuICBjb29raW5nVGltZTogbnVtYmVyOyAvLyBpbiBtaW51dGVzXG4gIGRpZmZpY3VsdHlMZXZlbDogJ2Vhc3knIHwgJ21lZGl1bScgfCAnaGFyZCc7XG4gIHNlcnZpbmdzOiBudW1iZXI7XG4gIGRpZXRhcnlUYWdzOiBzdHJpbmdbXTtcbiAgaW1hZ2VVcmw/OiBzdHJpbmc7XG4gIGNyZWF0ZWRBdDogc3RyaW5nO1xuICB1cGRhdGVkQXQ6IHN0cmluZztcbiAgcmF0aW5nPzogbnVtYmVyO1xuICByZXZpZXdDb3VudD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgY29uc3QgaGVhZGVycyA9IHtcbiAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ0dFVCxQT1NULFBVVCxERUxFVEUsT1BUSU9OUycsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBjb25zdCB7IGh0dHBNZXRob2QsIHBhdGgsIHBhdGhQYXJhbWV0ZXJzLCBxdWVyeVN0cmluZ1BhcmFtZXRlcnMgfSA9IGV2ZW50O1xuICAgIGNvbnN0IGJvZHkgPSBldmVudC5ib2R5ID8gSlNPTi5wYXJzZShldmVudC5ib2R5KSA6IHt9O1xuXG4gICAgaWYgKGh0dHBNZXRob2QgPT09ICdPUFRJT05TJykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiAnJyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKHBhdGggPT09ICcvcmVjaXBlcycgJiYgaHR0cE1ldGhvZCA9PT0gJ0dFVCcpIHtcbiAgICAgIHJldHVybiBhd2FpdCBnZXRSZWNpcGVzKHF1ZXJ5U3RyaW5nUGFyYW1ldGVycyk7XG4gICAgfVxuXG4gICAgaWYgKHBhdGggPT09ICcvcmVjaXBlcycgJiYgaHR0cE1ldGhvZCA9PT0gJ1BPU1QnKSB7XG4gICAgICByZXR1cm4gYXdhaXQgY3JlYXRlUmVjaXBlKGJvZHksIGV2ZW50LmhlYWRlcnMuQXV0aG9yaXphdGlvbik7XG4gICAgfVxuXG4gICAgaWYgKHBhdGhQYXJhbWV0ZXJzPy5pZCAmJiBodHRwTWV0aG9kID09PSAnR0VUJykge1xuICAgICAgcmV0dXJuIGF3YWl0IGdldFJlY2lwZShwYXRoUGFyYW1ldGVycy5pZCk7XG4gICAgfVxuXG4gICAgaWYgKHBhdGhQYXJhbWV0ZXJzPy5pZCAmJiBodHRwTWV0aG9kID09PSAnUFVUJykge1xuICAgICAgcmV0dXJuIGF3YWl0IHVwZGF0ZVJlY2lwZShwYXRoUGFyYW1ldGVycy5pZCwgYm9keSwgZXZlbnQuaGVhZGVycy5BdXRob3JpemF0aW9uKTtcbiAgICB9XG5cbiAgICBpZiAocGF0aFBhcmFtZXRlcnM/LmlkICYmIGh0dHBNZXRob2QgPT09ICdERUxFVEUnKSB7XG4gICAgICByZXR1cm4gYXdhaXQgZGVsZXRlUmVjaXBlKHBhdGhQYXJhbWV0ZXJzLmlkLCBldmVudC5oZWFkZXJzLkF1dGhvcml6YXRpb24pO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDQsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ05vdCBmb3VuZCcgfSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdSZWNpcGVzIGVycm9yOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InIH0pLFxuICAgIH07XG4gIH1cbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFJlY2lwZXMocXVlcnlQYXJhbXM6IGFueSk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGNvbnN0IGhlYWRlcnMgPSB7XG4gICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgY29uc3QgeyBpbmdyZWRpZW50LCB1c2VySWQsIGxpbWl0ID0gJzIwJywgbGFzdEtleSB9ID0gcXVlcnlQYXJhbXMgfHwge307XG5cbiAgICBsZXQgcmVjaXBlczogUmVjaXBlW10gPSBbXTtcblxuICAgIGlmIChpbmdyZWRpZW50KSB7XG4gICAgICAvLyBTZWFyY2ggYnkgaW5ncmVkaWVudCB1c2luZyBHU0lcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlJFQ0lQRVNfVEFCTEUsXG4gICAgICAgIEluZGV4TmFtZTogJ2luZ3JlZGllbnRzLWluZGV4JyxcbiAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ2luZ3JlZGllbnQgPSA6aW5ncmVkaWVudCcsXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAnOmluZ3JlZGllbnQnOiBpbmdyZWRpZW50LnRvTG93ZXJDYXNlKCksXG4gICAgICAgIH0sXG4gICAgICAgIExpbWl0OiBwYXJzZUludChsaW1pdCksXG4gICAgICB9KSk7XG4gICAgICByZWNpcGVzID0gcmVzdWx0Lkl0ZW1zIGFzIFJlY2lwZVtdIHx8IFtdO1xuICAgIH0gZWxzZSBpZiAodXNlcklkKSB7XG4gICAgICAvLyBHZXQgdXNlcidzIHJlY2lwZXNcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlJFQ0lQRVNfVEFCTEUsXG4gICAgICAgIEluZGV4TmFtZTogJ3VzZXItcmVjaXBlcy1pbmRleCcsXG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICd1c2VySWQgPSA6dXNlcklkJyxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICc6dXNlcklkJzogdXNlcklkLFxuICAgICAgICB9LFxuICAgICAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZSwgLy8gTW9zdCByZWNlbnQgZmlyc3RcbiAgICAgICAgTGltaXQ6IHBhcnNlSW50KGxpbWl0KSxcbiAgICAgIH0pKTtcbiAgICAgIHJlY2lwZXMgPSByZXN1bHQuSXRlbXMgYXMgUmVjaXBlW10gfHwgW107XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEdldCBhbGwgcmVjaXBlc1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IFNjYW5Db21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5SRUNJUEVTX1RBQkxFLFxuICAgICAgICBMaW1pdDogcGFyc2VJbnQobGltaXQpLFxuICAgICAgfSkpO1xuICAgICAgcmVjaXBlcyA9IHJlc3VsdC5JdGVtcyBhcyBSZWNpcGVbXSB8fCBbXTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgcmVjaXBlcyB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0dldCByZWNpcGVzIGVycm9yOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdGYWlsZWQgdG8gZ2V0IHJlY2lwZXMnIH0pLFxuICAgIH07XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlUmVjaXBlKHJlY2lwZURhdGE6IGFueSwgYXV0aG9yaXphdGlvbj86IHN0cmluZyk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGNvbnN0IGhlYWRlcnMgPSB7XG4gICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgaWYgKCFhdXRob3JpemF0aW9uKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA0MDEsXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdBdXRob3JpemF0aW9uIHJlcXVpcmVkJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgdXNlcklkID0gZXh0cmFjdFVzZXJJZEZyb21Ub2tlbihhdXRob3JpemF0aW9uKTtcbiAgICBjb25zdCByZWNpcGVJZCA9IGdlbmVyYXRlSWQoKTtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG5cbiAgICBjb25zdCByZWNpcGU6IFJlY2lwZSA9IHtcbiAgICAgIHJlY2lwZUlkLFxuICAgICAgdXNlcklkLFxuICAgICAgdGl0bGU6IHJlY2lwZURhdGEudGl0bGUsXG4gICAgICBkZXNjcmlwdGlvbjogcmVjaXBlRGF0YS5kZXNjcmlwdGlvbixcbiAgICAgIGluZ3JlZGllbnRzOiByZWNpcGVEYXRhLmluZ3JlZGllbnRzIHx8IFtdLFxuICAgICAgaW5zdHJ1Y3Rpb25zOiByZWNpcGVEYXRhLmluc3RydWN0aW9ucyB8fCBbXSxcbiAgICAgIGNvb2tpbmdUaW1lOiByZWNpcGVEYXRhLmNvb2tpbmdUaW1lIHx8IDMwLFxuICAgICAgZGlmZmljdWx0eUxldmVsOiByZWNpcGVEYXRhLmRpZmZpY3VsdHlMZXZlbCB8fCAnbWVkaXVtJyxcbiAgICAgIHNlcnZpbmdzOiByZWNpcGVEYXRhLnNlcnZpbmdzIHx8IDQsXG4gICAgICBkaWV0YXJ5VGFnczogcmVjaXBlRGF0YS5kaWV0YXJ5VGFncyB8fCBbXSxcbiAgICAgIGNyZWF0ZWRBdDogbm93LFxuICAgICAgdXBkYXRlZEF0OiBub3csXG4gICAgfTtcblxuICAgIC8vIFNhdmUgcmVjaXBlXG4gICAgYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IFB1dENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5SRUNJUEVTX1RBQkxFLFxuICAgICAgSXRlbTogcmVjaXBlLFxuICAgIH0pKTtcblxuICAgIC8vIFNhdmUgaW5ncmVkaWVudCBtYXBwaW5ncyBmb3Igc2VhcmNoXG4gICAgZm9yIChjb25zdCBpbmdyZWRpZW50IG9mIHJlY2lwZS5pbmdyZWRpZW50cykge1xuICAgICAgYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IFB1dENvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlJFQ0lQRVNfVEFCTEUsXG4gICAgICAgIEl0ZW06IHtcbiAgICAgICAgICByZWNpcGVJZDogcmVjaXBlLnJlY2lwZUlkLFxuICAgICAgICAgIGluZ3JlZGllbnQ6IGluZ3JlZGllbnQubmFtZS50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgIGNyZWF0ZWRBdDogbm93LFxuICAgICAgICB9LFxuICAgICAgfSkpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDEsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyByZWNpcGUgfSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdDcmVhdGUgcmVjaXBlIGVycm9yOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdGYWlsZWQgdG8gY3JlYXRlIHJlY2lwZScgfSksXG4gICAgfTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRSZWNpcGUocmVjaXBlSWQ6IHN0cmluZyk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGNvbnN0IGhlYWRlcnMgPSB7XG4gICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5SRUNJUEVTX1RBQkxFLFxuICAgICAgS2V5OiB7IHJlY2lwZUlkIH0sIC8vIFVzZSByZWNpcGVJZCBhcyBwcmltYXJ5IGtleSBvbmx5XG4gICAgfSkpO1xuXG4gICAgaWYgKCFyZXN1bHQuSXRlbSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDA0LFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnUmVjaXBlIG5vdCBmb3VuZCcgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyByZWNpcGU6IHJlc3VsdC5JdGVtIH0pLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignR2V0IHJlY2lwZSBlcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnRmFpbGVkIHRvIGdldCByZWNpcGUnIH0pLFxuICAgIH07XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlUmVjaXBlKHJlY2lwZUlkOiBzdHJpbmcsIHJlY2lwZURhdGE6IGFueSwgYXV0aG9yaXphdGlvbj86IHN0cmluZyk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGNvbnN0IGhlYWRlcnMgPSB7XG4gICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgaWYgKCFhdXRob3JpemF0aW9uKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA0MDEsXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdBdXRob3JpemF0aW9uIHJlcXVpcmVkJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgdXNlcklkID0gZXh0cmFjdFVzZXJJZEZyb21Ub2tlbihhdXRob3JpemF0aW9uKTtcblxuICAgIC8vIEdldCBleGlzdGluZyByZWNpcGVcbiAgICBjb25zdCBleGlzdGluZ1JlY2lwZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuUkVDSVBFU19UQUJMRSxcbiAgICAgIEtleTogeyByZWNpcGVJZCB9LFxuICAgIH0pKTtcblxuICAgIGlmICghZXhpc3RpbmdSZWNpcGUuSXRlbSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDA0LFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnUmVjaXBlIG5vdCBmb3VuZCcgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChleGlzdGluZ1JlY2lwZS5JdGVtLnVzZXJJZCAhPT0gdXNlcklkKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA0MDMsXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdOb3QgYXV0aG9yaXplZCB0byB1cGRhdGUgdGhpcyByZWNpcGUnIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBVcGRhdGUgcmVjaXBlXG4gICAgY29uc3QgdXBkYXRlZFJlY2lwZSA9IHtcbiAgICAgIC4uLmV4aXN0aW5nUmVjaXBlLkl0ZW0sXG4gICAgICAuLi5yZWNpcGVEYXRhLFxuICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgfTtcblxuICAgIGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBQdXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuUkVDSVBFU19UQUJMRSxcbiAgICAgIEl0ZW06IHVwZGF0ZWRSZWNpcGUsXG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IHJlY2lwZTogdXBkYXRlZFJlY2lwZSB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ1VwZGF0ZSByZWNpcGUgZXJyb3I6JywgZXJyb3IpO1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ZhaWxlZCB0byB1cGRhdGUgcmVjaXBlJyB9KSxcbiAgICB9O1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlbGV0ZVJlY2lwZShyZWNpcGVJZDogc3RyaW5nLCBhdXRob3JpemF0aW9uPzogc3RyaW5nKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcbiAgY29uc3QgaGVhZGVycyA9IHtcbiAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBpZiAoIWF1dGhvcml6YXRpb24pIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMSxcbiAgICAgICAgaGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0F1dGhvcml6YXRpb24gcmVxdWlyZWQnIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCB1c2VySWQgPSBleHRyYWN0VXNlcklkRnJvbVRva2VuKGF1dGhvcml6YXRpb24pO1xuXG4gICAgLy8gR2V0IGV4aXN0aW5nIHJlY2lwZSB0byBjaGVjayBvd25lcnNoaXBcbiAgICBjb25zdCBleGlzdGluZ1JlY2lwZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuUkVDSVBFU19UQUJMRSxcbiAgICAgIEtleTogeyByZWNpcGVJZCB9LFxuICAgIH0pKTtcblxuICAgIGlmICghZXhpc3RpbmdSZWNpcGUuSXRlbSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDA0LFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnUmVjaXBlIG5vdCBmb3VuZCcgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChleGlzdGluZ1JlY2lwZS5JdGVtLnVzZXJJZCAhPT0gdXNlcklkKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA0MDMsXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdOb3QgYXV0aG9yaXplZCB0byBkZWxldGUgdGhpcyByZWNpcGUnIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBEZWxldGUgcmVjaXBlXG4gICAgYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IERlbGV0ZUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5SRUNJUEVTX1RBQkxFLFxuICAgICAgS2V5OiB7IHJlY2lwZUlkIH0sXG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6ICdSZWNpcGUgZGVsZXRlZCBzdWNjZXNzZnVsbHknIH0pLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRGVsZXRlIHJlY2lwZSBlcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnRmFpbGVkIHRvIGRlbGV0ZSByZWNpcGUnIH0pLFxuICAgIH07XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVJZCgpOiBzdHJpbmcge1xuICByZXR1cm4gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpO1xufVxuXG5mdW5jdGlvbiBleHRyYWN0VXNlcklkRnJvbVRva2VuKGF1dGhvcml6YXRpb246IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IHRva2VuID0gYXV0aG9yaXphdGlvbi5yZXBsYWNlKCdCZWFyZXIgJywgJycpO1xuICByZXR1cm4gdG9rZW47XG59XG4iXX0=